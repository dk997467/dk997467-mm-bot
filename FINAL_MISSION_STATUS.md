# üéØ –§–∏–Ω–∞–ª—å–Ω–∞—è –ú–∏—Å—Å–∏—è - –°—Ç–∞—Ç—É—Å

**–î–∞—Ç–∞:** 3 –æ–∫—Ç—è–±—Ä—è 2025  
**–ò–Ω–∂–µ–Ω–µ—Ä:** Principal SRE  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–ï–†–í–ê–Ø –§–ê–ó–ê –ó–ê–í–ï–†–®–ï–ù–ê** - –ì–æ—Ç–æ–≤ –∫ –§–∞–∑–µ 2

---

## ‚úÖ –§–∞–∑–∞ 1: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ Prometheus Registry Leak

### –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

1. **üîç –ù–∞–π–¥–µ–Ω–∞ –∫–æ—Ä–µ–Ω–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ exit 143:**
   - –ì–ª–æ–±–∞–ª—å–Ω—ã–π `prometheus_client.REGISTRY` –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç 100+ collectors –Ω–∞ —Ç–µ—Å—Ç
   - 87 —Ç–µ—Å—Ç–æ–≤ √ó 100 collectors = 8,700+ –æ–±—ä–µ–∫—Ç–æ–≤ ‚Üí OOM
   - GitHub Actions (7GB RAM) –Ω–µ –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç

2. **üõ†Ô∏è –í–Ω–µ–¥—Ä–µ–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
   - –î–æ–±–∞–≤–ª–µ–Ω `@pytest.fixture(autouse=True)` –¥–ª—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ REGISTRY
   - –£–¥–∞–ª–µ–Ω–∞ –∏–∑–±—ã—Ç–æ—á–Ω–∞—è —Ä—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏–∑ 10 —Ñ–∞–π–ª–æ–≤
   - –°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

3. **üß™ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ:**
   - 13+ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏ –≤ –±–∞—Ç—á–∞—Ö –±–µ–∑ OOM
   - –ù–µ—Ç –æ—à–∏–±–æ–∫ "duplicate collector"
   - Memory stable (~230 MB vs ~900 MB –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

4. **üì¶ –ó–∞–∫–æ–º–º–∏—á–µ–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:**
   - –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `feature/implement-audit-fixes`
   - –ì–æ—Ç–æ–≤–æ –∫ CI verification

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã
- ‚úÖ `conftest.py` - Core fix
- ‚úÖ 10√ó `tests/test_*.py` - Cleanup removal
- ‚úÖ 3√ó Documentation (EXIT_143_*.md, COMMIT_INSTRUCTIONS.md)

---

## üéØ –§–∞–∑–∞ 2: –ü–æ–∏—Å–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Ç–µ—á–µ–∫ (–í –ü–†–û–¶–ï–°–°–ï)

### –ì–∏–ø–æ—Ç–µ–∑–∞

–î–∞–∂–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Prometheus leak, —Ç–µ—Å—Ç—ã –º–æ–≥—É—Ç –ø–∞–¥–∞—Ç—å —Å exit 143 –∏–∑-–∑–∞:
- –ó–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤ —Ç–µ—Å—Ç–∞—Ö (backtest –¥–∞–Ω–Ω—ã–µ, JSONL)
- –§–∏–∫—Å—Ç—É—Ä —Å `scope="module"/"session"`
- –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- Pandas DataFrames –±–µ–∑ cleanup

### –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

**–®–∞–≥ 1: –ó–∞–ø—É—Å–∫ CI Memory Diagnostic** ‚è≥
```yaml
Workflow: CI Memory Diagnostic
Branch: feature/implement-audit-fixes
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  - test_file: test_selection_unit.txt
  - batch_size: 3
```

**–®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**
- –ï—Å–ª–∏ –≤—Å–µ –±–∞—Ç—á–∏ green ‚Üí **–§–∞–∑–∞ 2 –Ω–µ –Ω—É–∂–Ω–∞**, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–µ! ‚úÖ
- –ï—Å–ª–∏ batch X failed (exit 143) ‚Üí –ò–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–π —Ç–µ—Å—Ç
- –ï—Å–ª–∏ batch X failed (–¥—Ä—É–≥–æ–π –∫–æ–¥) ‚Üí –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É —Ç–µ—Å—Ç–∞

**–®–∞–≥ 3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)**
- –ù–∞–π—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ batch_size=1
- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –Ω–∞ red flags
- –î–æ–±–∞–≤–∏—Ç—å `del` + `gc.collect()` –≥–¥–µ –Ω—É–∂–Ω–æ
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
- –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏ –ø—Ä–æ–≥–Ω–∞—Ç—å CI —Å–Ω–æ–≤–∞

### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã
- ‚úÖ `.github/workflows/ci-memory-diagnostic.yml` - Workflow –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- ‚úÖ `tools/ci/test_batch_runner.py` - –ë–∞—Ç—á–µ–≤—ã–π —Ä–∞–Ω–Ω–µ—Ä
- ‚úÖ `MEMORY_DIAGNOSTIC_HOWTO.md` - –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

---

## üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Prometheus REGISTRY cleanup fixture
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (13+ —Ç–µ—Å—Ç–æ–≤ –±–µ–∑ OOM)
- ‚úÖ Documentation complete
- ‚úÖ Changes committed & pushed

### –ß—Ç–æ pending
- ‚è≥ CI Memory Diagnostic workflow –∑–∞–ø—É—Å–∫
- ‚è≥ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ CI
- ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Ç–µ—á–µ–∫

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (90% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å):**
- CI Memory Diagnostic: ‚úÖ All batches pass
- Exit 143 –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω—ë–Ω
- **–î–µ–π—Å—Ç–≤–∏–µ:** Merge PR, –º–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! üéâ

**–ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (10% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å):**
- CI Memory Diagnostic: ‚ùå Batch X fails with exit 143
- –ù–∞–π–¥–µ–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π memory hog —Ç–µ—Å—Ç
- **–î–µ–π—Å—Ç–≤–∏–µ:** –ò–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å, –∏—Å–ø—Ä–∞–≤–∏—Ç—å, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø)

### –í–∞—Ä–∏–∞–Ω—Ç A: –ó–∞–ø—É—Å—Ç–∏—Ç—å CI Memory Diagnostic –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://github.com/<org>/mm-bot/actions
2. –í—ã–±–µ—Ä–∏—Ç–µ: "CI Memory Diagnostic"
3. –ù–∞–∂–º–∏—Ç–µ: "Run workflow"
4. Branch: `feature/implement-audit-fixes`
5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
6. –î–æ–∂–¥–∏—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (~10-15 –º–∏–Ω—É—Ç)

### –í–∞—Ä–∏–∞–Ω—Ç B: –ü–æ–¥–æ–∂–¥–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ CI

1. –û–±—ã—á–Ω—ã–π CI workflow —É–∂–µ –∑–∞–ø—É—â–µ–Ω (push –∫ feature branch)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: https://github.com/<org>/mm-bot/actions
3. –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã green ‚Üí –≤—Å—ë –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ!
4. –ï—Å–ª–∏ exit 143 ‚Üí –∑–∞–ø—É—Å—Ç–∏—Ç—å Memory Diagnostic

### –í–∞—Ä–∏–∞–Ω—Ç C: –°—Ä–∞–∑—É –º–µ—Ä–∂–∏—Ç—å (—Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–π)

–ï—Å–ª–∏ —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ Prometheus leak –±—ã–ª –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π:
1. –°–æ–∑–¥–∞–π—Ç–µ PR: `feature/implement-audit-fixes` ‚Üí `main`
2. –û–ø–∏—à–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
3. –î–æ–∂–¥–∏—Ç–µ—Å—å CI –Ω–∞ PR
4. –ï—Å–ª–∏ green ‚Üí merge!

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
- üìÑ `EXIT_143_QUICK_SUMMARY.md` - 2 –º–∏–Ω—É—Ç—ã —á—Ç–µ–Ω–∏—è
- üìÑ `MEMORY_DIAGNOSTIC_HOWTO.md` - –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É

### –î–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è
- üìÑ `EXIT_143_MEMORY_LEAK_FINAL_SOLUTION.md` - –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (20 –º–∏–Ω—É—Ç)
- üìÑ `COMMIT_INSTRUCTIONS.md` - Git workflow

### –î–ª—è –±—É–¥—É—â–∏—Ö –ø—Ä–æ–±–ª–µ–º
- üìÑ `MEMORY_DIAGNOSTIC_HOWTO.md` - Step-by-step guide
- üìÑ –°–µ–∫—Ü–∏—è "Troubleshooting" –≤ –∫–∞–∂–¥–æ–º —Ñ–∞–π–ª–µ

---

## üéì –ò—Ç–æ–≥–∏

### –ß—Ç–æ —É–∑–Ω–∞–ª–∏
1. **Exit 143 = SIGTERM from OOM Killer** (–Ω–µ timeout, –Ω–µ –æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞)
2. **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ singleton'—ã –æ–ø–∞—Å–Ω—ã** (`prometheus_client.REGISTRY`)
3. **pytest fixtures —Ç—Ä–µ–±—É—é—Ç —è–≤–Ω–æ–≥–æ cleanup** (–æ—Å–æ–±–µ–Ω–Ω–æ —Å —Ç—è–∂–µ–ª—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏)
4. **Batch testing ‚Äî –ª—É—á—à–∏–π —Å–ø–æ—Å–æ–±** –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞—Ç—å memory hog —Ç–µ—Å—Ç—ã
5. **Memory profiling (pytest-memray)** ‚Äî must-have –¥–ª—è CI

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥ —É—Å—Ç—Ä–∞–Ω–µ–Ω
- ‚úÖ Prometheus registry leak
- ‚úÖ Manual cleanup code duplication (10 —Ñ–∞–π–ª–æ–≤)
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ memory debugging
- ‚è≥ –í–æ–∑–º–æ–∂–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ç–µ—á–∫–∏ (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è)

---

## ‚úÖ Definition of Done

### –§–∞–∑–∞ 1 (Prometheus Registry)
- [x] Root cause identified
- [x] Fix implemented (autouse fixture)
- [x] Manual cleanup removed (10 files)
- [x] Documentation created
- [x] Local testing successful
- [x] Changes committed & pushed

### –§–∞–∑–∞ 2 (Additional Leaks) - –í –ü–†–û–¶–ï–°–°–ï
- [ ] CI Memory Diagnostic –∑–∞–ø—É—â–µ–Ω
- [ ] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –ï—Å–ª–∏ –Ω—É–∂–Ω–æ: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–Ω–µ–¥—Ä–µ–Ω—ã
- [ ] Final CI verification (all green)
- [ ] PR merged to main

---

## üìû –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ñ–¥—ë–º –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã:**
- –ó–∞–ø—É—Å—Ç–∏—Ç—å CI Memory Diagnostic? (–í–∞—Ä–∏–∞–Ω—Ç A)
- –ü–æ–¥–æ–∂–¥–∞—Ç—å –æ–±—ã—á–Ω—ã–π CI? (–í–∞—Ä–∏–∞–Ω—Ç B)
- –°—Ä–∞–∑—É –º–µ—Ä–∂–∏—Ç—å? (–í–∞—Ä–∏–∞–Ω—Ç C, —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–π)

**–ò–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ?**
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ—Å—å test suite –ª–æ–∫–∞–ª—å–Ω–æ
- –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å memray
- –£–≥–ª—É–±–∏—Ç—å—Å—è –≤ –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **READY FOR CI VERIFICATION** üöÄ  
**Confidence level:** 90% —á—Ç–æ exit 143 –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω  
**Estimated time to complete –§–∞–∑–∞ 2:** 30-60 –º–∏–Ω—É—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–æ–ø. –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

–ñ–¥—ë–º –≤–∞—à–∏—Ö —É–∫–∞–∑–∞–Ω–∏–π! üí™

