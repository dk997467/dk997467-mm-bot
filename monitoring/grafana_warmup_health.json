{
  "dashboard": {
    "title": "Soak Warm-up Health",
    "tags": ["soak", "warmup", "kpi"],
    "timezone": "utc",
    "editable": true,
    "hideControls": false,
    "graphTooltip": 1,
    "panels": [
      {
        "id": 1,
        "title": "Warm-up Phase Progress",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
        "targets": [
          {
            "expr": "warmup_active",
            "legendFormat": "Warmup Active (1=yes)",
            "refId": "A"
          },
          {
            "expr": "rampdown_active",
            "legendFormat": "Rampdown Active (1=yes)",
            "refId": "B"
          },
          {
            "expr": "soak_phase_name",
            "legendFormat": "Phase (0=warmup, 1=rampdown, 2=steady)",
            "refId": "C"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "stepAfter",
              "fillOpacity": 10
            }
          }
        }
      },
      {
        "id": 2,
        "title": "KPI by Phase (Iterations 1-8)",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
        "targets": [
          {
            "expr": "soak_maker_taker_ratio{iteration=~\"[1-8]\"}",
            "legendFormat": "Maker/Taker - iter {{iteration}} ({{phase}})",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "linear",
              "fillOpacity": 0
            },
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": null, "color": "red"},
                {"value": 0.83, "color": "green"}
              ]
            }
          }
        }
      },
      {
        "id": 3,
        "title": "P95 Latency by Phase",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
        "targets": [
          {
            "expr": "soak_p95_latency_ms{iteration=~\"[1-8]\"}",
            "legendFormat": "P95 Latency - iter {{iteration}} ({{phase}})",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "ms",
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "linear",
              "fillOpacity": 10
            },
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": null, "color": "green"},
                {"value": 340, "color": "yellow"},
                {"value": 360, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "id": 4,
        "title": "Risk Ratio by Phase",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
        "targets": [
          {
            "expr": "soak_risk_ratio{iteration=~\"[1-8]\"}",
            "legendFormat": "Risk - iter {{iteration}} ({{phase}})",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percentunit",
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "linear",
              "fillOpacity": 10
            },
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": null, "color": "green"},
                {"value": 0.40, "color": "yellow"},
                {"value": 0.50, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "id": 5,
        "title": "Guard Triggers (Total)",
        "type": "stat",
        "gridPos": {"h": 4, "w": 6, "x": 0, "y": 16},
        "targets": [
          {
            "expr": "sum(guard_triggers_total)",
            "legendFormat": "Total Guards",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": null, "color": "green"},
                {"value": 3, "color": "yellow"},
                {"value": 5, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "id": 6,
        "title": "Velocity Guards (Warmup)",
        "type": "stat",
        "gridPos": {"h": 4, "w": 6, "x": 6, "y": 16},
        "targets": [
          {
            "expr": "guard_triggers_total{type=\"velocity\"}",
            "legendFormat": "Velocity",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": null, "color": "green"},
                {"value": 2, "color": "yellow"},
                {"value": 4, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "id": 7,
        "title": "Oscillation Guards",
        "type": "stat",
        "gridPos": {"h": 4, "w": 6, "x": 12, "y": 16},
        "targets": [
          {
            "expr": "guard_triggers_total{type=\"oscillation\"}",
            "legendFormat": "Oscillation",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": null, "color": "green"},
                {"value": 1, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "id": 8,
        "title": "Tuner Activity (Keys Changed)",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 20},
        "targets": [
          {
            "expr": "tuner_keys_changed_total",
            "legendFormat": "Keys Changed - iter {{iteration}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "bars",
              "fillOpacity": 50
            },
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": null, "color": "green"},
                {"value": 2.1, "color": "yellow"},
                {"value": 3, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "id": 9,
        "title": "Last-8 Summary Metrics",
        "type": "stat",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 20},
        "targets": [
          {
            "expr": "maker_taker_ratio_hmean{window=\"8\"}",
            "legendFormat": "Maker/Taker (Hmean)",
            "refId": "A"
          },
          {
            "expr": "risk_ratio_mean{window=\"8\"}",
            "legendFormat": "Risk (Mean)",
            "refId": "B"
          },
          {
            "expr": "p95_latency_ms_max{window=\"8\"}",
            "legendFormat": "P95 Latency (Max)",
            "refId": "C"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "mappings": [],
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": null, "color": "green"}
              ]
            }
          },
          "overrides": [
            {
              "matcher": {"id": "byName", "options": "Maker/Taker (Hmean)"},
              "properties": [
                {
                  "id": "thresholds",
                  "value": {
                    "mode": "absolute",
                    "steps": [
                      {"value": null, "color": "red"},
                      {"value": 0.83, "color": "green"}
                    ]
                  }
                }
              ]
            },
            {
              "matcher": {"id": "byName", "options": "P95 Latency (Max)"},
              "properties": [
                {
                  "id": "unit",
                  "value": "ms"
                },
                {
                  "id": "thresholds",
                  "value": {
                    "mode": "absolute",
                    "steps": [
                      {"value": null, "color": "green"},
                      {"value": 340, "color": "red"}
                    ]
                  }
                }
              ]
            }
          ]
        }
      }
    ],
    "annotations": {
      "list": [
        {
          "datasource": "Prometheus",
          "enable": true,
          "expr": "changes(warmup_active[1m]) > 0",
          "name": "Phase Transitions",
          "step": "1m",
          "tagKeys": "phase",
          "titleFormat": "Phase Change",
          "textFormat": "{{phase}}"
        }
      ]
    },
    "refresh": "10s",
    "time": {"from": "now-1h", "to": "now"},
    "timepicker": {}
  }
}

